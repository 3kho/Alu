<script>
  import IDBManager from "@components/ts/IDBManager";

  function switchTheme() {
    let currentTheme = localStorage.getItem("alu__selectedTheme");

    if (currentTheme) {
      document.documentElement.setAttribute("data-theme", JSON.parse(currentTheme).value.toLowerCase());
      let footer = document.getElementById("footer");
      if (footer) {
        footer.dataset.theme = JSON.parse(currentTheme).value.toLowerCase();
      }
    } else {
      localStorage.setItem("alu__selectedTheme", JSON.stringify({ name: "Alu", value: "alu" }));
      switchTheme();
    }
  }

  switchTheme();

  document.addEventListener("astro:after-swap", switchTheme);

  const idb = IDBManager.loadIDB("AluDB", 1);

  idb.onsuccess = () => {
    let store = IDBManager.GetStore("InstalledExtensions", "readonly");
    store.getAll().onsuccess = (event) => {
      const result = (event.target as IDBRequest).result;
      if (result) {
        result.forEach((extension: IExtensionMetadata) => {
          if (extension.type === "theme" && extension.themeName) {
            // Load theme CSS
            console.log("Attempting to load theme", extension.themeName);
            loadStyleFromAtob(atob(extension.scriptCopy!));

            document.addEventListener("astro:after-swap", () => {
              loadStyleFromAtob(atob(extension.scriptCopy!));
            });
          }
        });
      }
    };
  };
  function loadStyleFromAtob(style: string) {
    const styleEl = document.createElement("style");
    styleEl.textContent = style;
    document.head.appendChild(styleEl);
  }
</script>
